<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Storyline App</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2196F3">

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAjxr-5XZgYWKsUwPskXQc5WxzOqtR5pnY",
      authDomain: "story-line-d2849.firebaseapp.com",
      projectId: "story-line-d2849",
      storageBucket: "story-line-d2849.firebasestorage.app",
      messagingSenderId: "100849395388",
      appId: "1:100849395388:web:8d7410c67b7206957692b9"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const db = getFirestore(firebaseApp);

    // Make Firebase available globally
    window.firebaseApp = firebaseApp;
    window.db = db;
  </script>
</head>

<body>
  <div class="app">
    <header class="header">
      <h1>ğŸ“– Storyline</h1>
      <button id="newStoryBtn" class="btn btn-primary">+ New Story</button>
    </header>

    <main class="main">
      <!-- Story List View -->
      <div id="storyListView" class="view active">
        <div class="sync-controls">
          <!-- Upload Dropdown -->
          <div class="sync-dropdown">
            <button id="syncToCloudBtn" class="btn btn-sync dropdown-toggle">â¬†ï¸ Upload</button>
            <div id="uploadModeMenu" class="sync-dropdown-menu">
              <button class="sync-dropdown-item" onclick="app.syncToCloud('replace')">
                ğŸ”„ Replace Mode
                <span class="mode-description">Overwrite cloud with local stories</span>
              </button>
              <button class="sync-dropdown-item" onclick="app.syncToCloud('merge')">
                ğŸ¤ Merge Mode
                <span class="mode-description">Keep latest version of each story</span>
              </button>
            </div>
          </div>
          
          <!-- Download Dropdown -->
          <div class="sync-dropdown">
            <button id="syncFromCloudBtn" class="btn btn-sync dropdown-toggle">â¬‡ï¸ Download</button>
            <div id="downloadModeMenu" class="sync-dropdown-menu">
              <button class="sync-dropdown-item" onclick="app.syncFromCloud('replace')">
                ğŸ”„ Replace Mode
                <span class="mode-description">Overwrite local with cloud stories</span>
              </button>
              <button class="sync-dropdown-item" onclick="app.syncFromCloud('merge')">
                ğŸ¤ Merge Mode
                <span class="mode-description">Keep latest version of each story</span>
              </button>
            </div>
          </div>
          
          <button id="manageVersionsBtn" class="btn btn-sync">ğŸ“‹ Versions</button>
          <button id="clearCacheBtn" class="btn btn-cache">â« Update App</button>
        </div>

        <div class="search-section">
          <div class="search-container">
            <input type="text" id="searchInput" placeholder="ğŸ” Search stories..." class="search-input">
            <button id="clearSearchBtn" class="search-clear" style="display: none;">Ã—</button>
          </div>
        </div>

        <div id="storyList" class="story-list"></div>
      </div>

      <!-- Story Editor View -->
      <div id="storyEditorView" class="view">
        <div class="editor-header">
          <button id="backBtn" class="btn btn-secondary">â† Back</button>
          <button id="previewBtn" class="btn btn-secondary">ğŸ‘ï¸ Preview</button>
          <button id="editBtn" class="btn btn-secondary" style="display: none;">âœï¸ Edit</button>
          <button id="progressBtn" class="btn btn-secondary">ğŸ“Š Progress (0%)</button>
          <button id="progressEditBtn" class="btn btn-secondary" style="display: none;">âœï¸ Edit</button>
          <button id="jumpToParagraphBtn" class="btn btn-secondary">ğŸ” Jump to Â¶</button>
          
          <!-- Advanced Tools Dropdown -->
          <div class="advanced-dropdown">
            <button id="advancedBtn" class="btn btn-secondary dropdown-toggle">âš™ï¸ Advanced</button>
            <div id="advancedMenu" class="dropdown-menu">
              <div class="dropdown-section">
                <div class="dropdown-label">Story Tools</div>
                <button class="dropdown-item" onclick="app.showNotesModal()">ğŸ“ Notes</button>
                <button class="dropdown-item" onclick="app.showAiSettingsModal()">ğŸ¤– AI Settings</button>
              </div>
              
              <div class="dropdown-section">
                <div class="dropdown-label">Copy Options</div>
                <button class="dropdown-item" onclick="app.showCopyOptionsMenu()">ğŸ“‹ Copy Paragraphs...</button>
              </div>
            </div>
          </div>
          
          <!-- Copy Options Submenu -->
          <div class="copy-options-dropdown" style="display: none;">
            <div id="copyOptionsMenu" class="dropdown-menu copy-menu">
              <div class="dropdown-section">
                <div class="dropdown-label">Copy Range</div>
                <button class="dropdown-item" onclick="app.copyAllParagraphs()">ğŸ“„ All Paragraphs</button>
                <button class="dropdown-item" onclick="app.copyTopParagraphs(5)">â¬†ï¸ Top 5 Paragraphs</button>
                <button class="dropdown-item" onclick="app.copyBottomParagraphs(5)">â¬‡ï¸ Bottom 5 Paragraphs</button>
                <button class="dropdown-item" onclick="app.copyCustomRange()">ğŸ¯ Custom Range...</button>
              </div>
              
              <div class="dropdown-section">
                <div class="dropdown-label">Copy Format</div>
                <button class="dropdown-item" onclick="app.copyHeadingsOnly()">ğŸ“ Headings Only</button>
                <button class="dropdown-item" onclick="app.copyWithContent()">ğŸ“– Headings + Content</button>
              </div>
              
              <div class="dropdown-section">
                <button class="dropdown-item back-btn" onclick="app.hideCopyOptionsMenu()">â† Back to Advanced</button>
              </div>
            </div>
          </div>
          
          <button id="saveStoryBtn" class="btn btn-primary">Save</button>
          <button id="deleteStoryBtn" class="btn btn-danger">Delete</button>
        </div>

        <!-- Edit Mode -->
        <div id="editMode" class="story-form">
          <input type="text" id="storyTitle" placeholder="Story Title" class="input-field">

          <div class="auto-save-toggle">
            <label class="toggle-label">
              <input type="checkbox" id="autoSaveToggle" class="toggle-input">
              <span class="toggle-slider"></span>
              <span class="toggle-text">Auto Save</span>
            </label>
          </div>

          <div class="paragraphs-section">
            <div class="section-header">
              <h3>Paragraphs</h3>
              <div class="section-controls">
                <button id="expandAllBtn" class="btn btn-small">Expand All</button>
                <button id="collapseAllBtn" class="btn btn-small">Collapse All</button>
                <button id="showAllParagraphsBtn" class="btn btn-small" style="display: none;">ğŸ“‹ Show All</button>
              </div>
            </div>

            <div class="paragraph-search-section">
              <div class="paragraph-search-container">
                <input type="text" id="paragraphSearchInput" placeholder="ğŸ” Search paragraphs..."
                  class="paragraph-search-input">
                <button id="clearParagraphSearchBtn" class="paragraph-search-clear" style="display: none;">Ã—</button>
              </div>
            </div>

            <div id="paragraphsList" class="paragraphs-list"></div>
            <div class="add-paragraph-section">
              <button id="addParagraphBtn" class="btn btn-primary">+ Add Paragraph</button>
            </div>
          </div>

          <div class="actions">
            <button id="copyStoryBtn" class="btn btn-secondary">ğŸ“‹ Copy Story</button>
          </div>
        </div>

        <!-- Preview Mode -->
        <div id="previewMode" class="preview-view" style="display: none;">
          <div id="previewContent" class="preview-content"></div>
        </div>

        <!-- Progress Mode -->
        <div id="progressMode" class="progress-view" style="display: none;">
          <div id="progressContent" class="progress-content"></div>
        </div>
      </div>

      <!-- Sticky Navigation Buttons -->
      <div id="stickyNavigation" class="sticky-navigation" style="display: none;">
        <button id="jumpToTopBtn" class="sticky-btn" title="Jump to top">â¬†ï¸</button>
        <button id="jumpToBottomBtn" class="sticky-btn" title="Jump to bottom">â¬‡ï¸</button>
      </div>
    </main>
  </div>

  <!-- Notes Modal -->
  <div id="notesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ“ Story Notes</h2>
        <button id="closeNotesBtn" class="modal-close">Ã—</button>
      </div>
      <div class="modal-body">
        <div id="notesContent" class="notes-content"></div>
      </div>
    </div>
  </div>

  <!-- Paragraph Note Modal -->
  <div id="paragraphNoteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="noteModalTitle">ğŸ“ Paragraph Notes</h2>
        <button id="closeParagraphNoteBtn" class="modal-close">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="notes-list" id="notesList">
          <!-- Individual notes will be rendered here -->
        </div>
        <div class="add-note-section">
          <textarea id="newNoteTextarea" placeholder="Add a new note..." class="note-textarea"></textarea>
          <div class="note-actions">
            <button id="addNoteBtn" class="btn btn-primary">Add Note</button>
            <button id="cancelNoteBtn" class="btn btn-secondary" style="display: none;">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Versions Management Modal -->
  <div id="versionsModal" class="modal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>ğŸ“‹ Version History</h2>
        <button id="closeVersionsBtn" class="modal-close">Ã—</button>
      </div>
      <div class="modal-body">
        <!-- Version Tabs -->
        <div class="version-tabs">
          <button id="autoVersionsTab" class="version-tab active" onclick="app.showVersionTab('auto')">
            ğŸ”„ Auto Backups
          </button>
          <button id="manualVersionsTab" class="version-tab" onclick="app.showVersionTab('manual')">
            ğŸ“ Manual Backups
          </button>
        </div>

        <!-- Auto Versions Content -->
        <div id="autoVersionsContent" class="version-tab-content active">
          <div class="versions-info">
            <p>Your last 5 backup versions are stored automatically when you upload to cloud. You can preview or restore any version.</p>
            <p><small>ğŸ’¡ New versions appear immediately after upload. Use refresh if needed.</small></p>
            <div class="versions-controls">
              <button id="refreshVersionsBtn" class="btn btn-secondary">ğŸ”„ Refresh</button>
            </div>
          </div>
          <div id="versionsList" class="versions-list">
            <!-- Auto versions will be rendered here -->
          </div>
        </div>

        <!-- Manual Versions Content -->
        <div id="manualVersionsContent" class="version-tab-content">
          <div class="versions-info">
            <p>Create and manage your own named backups. Manual backups are unlimited and stored locally.</p>
            <div class="manual-backup-controls">
              <input type="text" id="manualBackupName" placeholder="Backup name (optional)" class="backup-name-input">
              <button id="createManualBackupBtn" class="btn btn-primary">ğŸ’¾ Create Backup</button>
            </div>
          </div>
          <div id="manualVersionsList" class="versions-list">
            <!-- Manual versions will be rendered here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Settings Modal -->
  <div id="aiSettingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ¤– AI Preferences</h2>
        <button id="closeAiSettingsBtn" class="modal-close">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="ai-settings-form">
          <div class="setting-group">
            <label class="setting-label">AI Mode</label>
            <div class="radio-group">
              <label class="radio-option">
                <input type="radio" name="aiMode" value="smarter" id="aiModeSmarter">
                <span class="radio-text">ğŸ§  Smarter (Llama-3.1-70B) - Better quality, slower</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="aiMode" value="faster" id="aiModeFaster">
                <span class="radio-text">âš¡ Faster (Llama-3.1-8B-instant) - Quick responses</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="aiMode" value="custom" id="aiModeCustom">
                <span class="radio-text">ğŸ¯ Custom Model - Choose specific model</span>
              </label>
            </div>
            
            <div id="customModelSection" class="custom-model-section" style="display: none;">
              <label class="setting-label">Select Model</label>
              <div class="model-selector">
                <select id="customModelSelect" class="model-select">
                  <option value="">Loading models...</option>
                </select>
                <button id="refreshModelsBtn" class="btn btn-small" type="button">ğŸ”„ Refresh</button>
              </div>
              <div class="model-info" id="modelInfo">
                <p>Select a model to see details</p>
              </div>
            </div>
          </div>

          <div class="setting-group">
            <label class="setting-label" for="customInstruction">Custom Instruction</label>
            <textarea id="customInstruction" class="setting-textarea" 
                      placeholder="Add custom instructions that will be included in every AI request (e.g., writing style, tone, specific requirements)..."></textarea>
          </div>

          <div class="setting-group">
            <label class="setting-label">API Keys</label>
            <div class="api-keys-section">
              <div id="apiKeysList" class="api-keys-list">
                <!-- API keys will be rendered here -->
              </div>
              <div class="add-api-key-section">
                <input type="password" id="newApiKey" class="setting-input" placeholder="Enter Groq API key...">
                <button id="addApiKeyBtn" class="btn btn-small">Add Key</button>
              </div>
              <div class="api-keys-info">
                <p>ğŸ’¡ Multiple API keys will be used in rotation for better rate limiting. Get your free API key from <a href="https://console.groq.com/keys" target="_blank">Groq Console</a>.</p>
              </div>
            </div>
          </div>

          <div class="setting-actions">
            <button id="saveAiSettingsBtn" class="btn btn-primary">Save Settings</button>
            <button id="testAiBtn" class="btn btn-secondary">Test AI Connection</button>
          </div>
        </div>
      </div>
    </div>
  </div>



  <script src="app.js"></script>
</body>

</html>